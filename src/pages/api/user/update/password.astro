---
import { setPassword, } from "../../../../database";
if (Astro.request.method != "POST")
    return new Response(undefined, { status: 405 });

const auth = Astro.request.headers.get("Authorization");
const url = Astro.url.searchParams.get("password");

if (auth) {
    const args = auth.split(" ");
    if (args.length == 2 && args[0] == "Bearer") {
        const token = args[1];
        if (await setPassword(token, await hash(url))) {
            return new Response(undefined, { status: 201 });
        } else {
            return new Response(undefined, { status: 401 });
        }
    }
} else {
    return new Response(undefined, { status: 401 });
}

async function hash(string) {
  const utf8 = new TextEncoder().encode(string);
  return await crypto.subtle.digest('SHA-256', utf8).then((hashBuffer) => {
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray
      .map((bytes) => bytes.toString(16).padStart(2, '0'))
      .join('');
    return hashHex;
  });
}
---
