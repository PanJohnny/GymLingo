---
import { getUser } from "../../../../database";
if (Astro.request.method != "GET") return new Response(undefined, 405);

const { token } = Astro.params;
if (!token) return new Response(undefined, { status: 400 });

const user = await getUser(token);
if (!user) return new Response(401);
async function fetchImage(url:string) {
    return await (await fetch(url)).blob();
}

if (!user.icon_url) {
    return new Response(
        await fetchImage(
            "https://ui-avatars.com/api/?format=svg&name=" +
                user.username.replaceAll(" ", "+"),
        ),
        { headers: { "Content-Type": "image/svg+xml" } },
    );
}
let type = user.icon_url.substring(user.icon_url.lastIndexOf(".") + 1);
if (type == "jpg") type = "jpeg";

let img = await fetchImage(user.icon_url);

if (img.size == 0) {
    img = await fetchImage("https://http.cat/404");
}
return new Response(img, {
    headers: {
        "Content-Type": "image/" + type,
    },
});


---
